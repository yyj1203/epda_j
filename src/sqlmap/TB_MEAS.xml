<?xml version="1.0" standalone="no"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://www.ibatis.com/dtd/sql-map-2.dtd">
<sqlMap namespace="tbMeas">	
	
	<typeAlias alias="CodeMap" type="com.kps.common.dto.CodeMap"/>
	
	<select id="getGroupMeasDate" resultClass="CodeMap">
		SELECT 
			CG_SEQ data,
			TO_CHAR(MEAS_DTIME, 'YYYY-MM-DD') label
			FROM TB_MEAS
			WHERE CG_SEQ = #CG_SEQ#
			GROUP BY CG_SEQ, TO_CHAR(MEAS_DTIME, 'YYYY-MM-DD')
	</select>
	
	<select id="getMeasureValues" resultClass="java.util.HashMap">
		SELECT T1.POINT_SEQ, 
		  (SELECT POINT_NAME FROM TB_POINT WHERE POINT_SEQ = T1.POINT_SEQ) POINT_NAME,
		  (SELECT TPLNR FROM TB_POINT WHERE POINT_SEQ = T1.POINT_SEQ) TPLNR,
		  T1.ITEM_SEQ,
		  T1.ITEM_MAX,
		  T1.ITEM_MIN,
		  (SELECT ITEM_NAME FROM TB_ITEM WHERE ITEM_SEQ = T1.ITEM_SEQ) ITEM_NAME,
		  (SELECT UNIT_NAME FROM TB_UNIT WHERE UNIT_SEQ = (SELECT UNIT_SEQ FROM TB_ITEM WHERE ITEM_SEQ = T1.ITEM_SEQ)) UNIT_NAME,
		  TO_CHAR(T2.MEAS_DTIME, 'YYYY-MM-DD') MEAS_DTIME,
		  T2.MEAS_VALUE,
		  T2.MEAS_STS,
		  T2.MEAS_STF
		FROM
		    (SELECT POINT_SEQ, ITEM_SEQ,
		      ITEM_MAX, ITEM_MIN
		      FROM TB_EPI
		      WHERE POINT_SEQ = #POINT_SEQ#
		      AND ITEM_SEQ = #ITEM_SEQ#
		    ) T1,
		    (SELECT A.* FROM TB_MEAS A,      
		        (SELECT 		            
		            POINT_SEQ, 
		            ITEM_SEQ,
		            MAX(MEAS_DTIME) MEAS_DTIME,
		            MEAS_CNT
		          FROM TB_MEAS 			
		          WHERE POINT_SEQ = #POINT_SEQ#
		          AND ITEM_SEQ = #ITEM_SEQ# 
		          AND MEAS_DTIME BETWEEN #START_DATE# AND #END_DATE#
		          GROUP BY POINT_SEQ, ITEM_SEQ, MEAS_CNT) B		      
		      WHERE A.POINT_SEQ = B.POINT_SEQ
		      AND A.ITEM_SEQ = B.ITEM_SEQ
		      AND A.MEAS_DTIME = B.MEAS_DTIME
		      AND A.MEAS_CNT = B.MEAS_CNT) T2
		WHERE T1.POINT_SEQ = T2.POINT_SEQ(+)
		AND T1.ITEM_SEQ = T2.ITEM_SEQ(+)		
	</select>	
	
	<select id="getMeasureValueHistory" resultClass="java.util.HashMap">
		SELECT 
			T2.CG_SEQ,
			T2.POINT_SEQ, 
			T2.ITEM_SEQ,			
			#TREND_NUM# TREND_NUM,				
			(SELECT ITEM_NAME FROM TB_ITEM WHERE ITEM_SEQ = T2.ITEM_SEQ) ITEM_NAME,
			T1.ITEM_MAX,
			T1.ITEM_MIN,
			(SELECT UNIT_NAME FROM TB_UNIT WHERE UNIT_SEQ = (SELECT UNIT_SEQ FROM TB_ITEM WHERE ITEM_SEQ = T1.ITEM_SEQ)) UNIT_NAME,
			TO_CHAR(T2.MEAS_DTIME, 'YYYY-MM-DD HH24:MI') MEAS_DTIME, 
			T2.MEAS_DTIME DATETIME, 
			T2.MEAS_VALUE,
			T2.MEAS_STS,
			T2.MEAS_STF, 
			(SELECT CCOD_DES FROM EVIB.TB_CCOD CC_1 WHERE CC_1.CCOD_CD2 = T2.MEAS_STS
					AND CCOD_CD1 = 'AE' AND CCOD_CD3 = '00' AND CC_1.CCOD_STS   = 'Y' ) MEAS_STS_NAME,
			(SELECT CCOD_DES FROM EVIB.TB_CCOD CC_1 WHERE CC_1.CCOD_CD2 = T2.MEAS_STF
    			AND CCOD_CD1 = 'AE' AND CCOD_CD3 = '00' AND CC_1.CCOD_STS   = 'Y' ) MEAS_STF_NAME,	
			T2.MEAS_DES
		FROM TB_EPI T1, TB_MEAS T2
		WHERE T2.POINT_SEQ = T1.POINT_SEQ
		AND T2.ITEM_SEQ = T1.ITEM_SEQ
		AND T2.POINT_SEQ = #POINT_SEQ#
		AND T2.ITEM_SEQ = #ITEM_SEQ#	
		AND T2.MEAS_DTIME BETWEEN #START_DATE# AND #END_DATE#
		ORDER BY T2.MEAS_DTIME
	</select>		
	
	
	<select id="getMeasureValueReport" resultClass="java.util.HashMap">
		SELECT B.TPLNR, B.POINT_NAME, B.PDM_INSP_SEQ, B.ITEM_NAME, 
			  B.ITEM_MIN, B.ITEM_MAX,  A.MEAS_VALUE, B.UNIT_SEQ, 
			  (SELECT UNIT_NAME FROM TB_UNIT WHERE UNIT_SEQ = (SELECT UNIT_SEQ FROM TB_ITEM WHERE ITEM_SEQ = B.ITEM_SEQ)) UNIT_NAME,
			  (SELECT CCOD_DES FROM EVIB.TB_CCOD CC_1 WHERE CC_1.CCOD_CD2 = A.MEAS_STS
			      AND CCOD_CD1 = 'AE' AND CCOD_CD3 = '00' AND CC_1.CCOD_STS   = 'Y' ) MEAS_STS_NAME,
			  (SELECT CCOD_DES FROM EVIB.TB_CCOD CC_1 WHERE CC_1.CCOD_CD2 = A.MEAS_STF
			      AND CCOD_CD1 = 'AE' AND CCOD_CD3 = '00' AND CC_1.CCOD_STS   = 'Y' ) MEAS_STF_NAME,	
			  TO_CHAR(A.MEAS_DTIME, 'YYYY-MM-DD') MEAS_DTIME,
			  A.MEAS_DES 
			FROM TB_MEAS A,
			  (SELECT T3.POINT_SEQ, T3.ITEM_SEQ, T3.UNIT_SEQ, T3.ITEM_MIN, T3.ITEM_MAX, 
			    T1.TPLNR, T1.POINT_NAME, 
			    T2.PDM_INSP_SEQ, T2.ITEM_NAME
			  FROM TB_POINT T1, TB_ITEM T2, TB_EPI T3 
			  WHERE T3.ITEM_SEQ = T2.ITEM_SEQ			  
			  AND T3.POINT_SEQ = T1.POINT_SEQ
			  
			<dynamic prepend="AND ">
				<iterate property="POINT_SEQ" 
							open="T3.POINT_SEQ IN (" 
							close=")" 
							conjunction=",">
					#POINT_SEQ[]#
				</iterate>
			</dynamic>			
			  
			  ) B 
			WHERE A.POINT_SEQ = B.POINT_SEQ
			AND A.ITEM_SEQ = B.ITEM_SEQ
	
	</select>
	
	<select id="getMeasForConfirm" resultClass="java.util.HashMap">
		SELECT CG_SEQ, POINT_SEQ, ITEM_SEQ, 
			TO_CHAR(MEAS_DTIME, 'YYYY-MM-DD HH24:MI') MEAS_DTIME,
			TPLNR, POINT_NAME, ITEM_NAME, 
			ITEM_MAX,
			ITEM_MIN,
			MEAS_VALUE,
			(SELECT UNIT_NAME FROM TB_UNIT WHERE UNIT_SEQ = TB_EPI.UNIT_SEQ) UNIT_NAME,			 
			MEAS_STF, 
			(SELECT CCOD_DES FROM EVIB.TB_CCOD CC_1 WHERE CC_1.CCOD_CD2 = MEAS_STF
				AND CCOD_CD1 = 'AE' AND CCOD_CD3 = '00' AND CC_1.CCOD_STS   = 'Y' ) MEAS_STF_NAME,
			<![CDATA[	
				CASE 
			        WHEN MEAS_STF IS NOT NULL THEN MEAS_STF         
			        ELSE 
				        CASE
							WHEN ITEM_MAX IS NULL OR ITEM_MIN IS NULL THEN '1'
							WHEN MEAS_VALUE >= ITEM_MIN AND MEAS_VALUE <= ITEM_MAX THEN '0'
							WHEN MEAS_VALUE < ITEM_MIN OR MEAS_VALUE < ITEM_MAX THEN '6'
				        END
			    END MEAS_STS
			]]>				
			FROM TB_MEAS 
			JOIN TB_POINT USING(POINT_SEQ)
			JOIN TB_ITEM USING(ITEM_SEQ)
			JOIN TB_EPI USING(POINT_SEQ, ITEM_SEQ)
			WHERE CG_SEQ = #CG_SEQ#
			AND MEAS_STS IS NULL
			AND TO_CHAR(MEAS_DTIME, 'YYYY-MM-DD') = #MEAS_DTIME#		
		
	</select>
	
	<update id="updateMeasForConfirm" parameterClass="java.util.HashMap">
		UPDATE TB_MEAS
		SET 
			MEAS_STS = #MEAS_STS#
		WHERE CG_SEQ = #CG_SEQ#
			AND POINT_SEQ = #POINT_SEQ#		
			AND ITEM_SEQ = #ITEM_SEQ#
			AND TO_CHAR(MEAS_DTIME, 'YYYY-MM-DD HH24:MI') = #MEAS_DTIME#
	</update>
	
	<update id="updateMeasValue" parameterClass="java.util.HashMap">
		UPDATE TB_MEAS
		SET 
			MEAS_VALUE = #MEAS_VALUE#
		WHERE CG_SEQ = #CG_SEQ#
			AND POINT_SEQ = #POINT_SEQ#		
			AND ITEM_SEQ = #ITEM_SEQ#
			AND TO_CHAR(MEAS_DTIME, 'YYYY-MM-DD HH24:MI') = #MEAS_DTIME#
	</update>
	
	<insert parameterClass="map" id="insertMeas">
		INSERT INTO TB_MEAS (
			MUSER2,
			MUSER3,
			MUSER4,
			MUSER5,
			MUSER1,
			CG_SEQ,
			POINT_SEQ,
			ITEM_SEQ,
			MEAS_DTIME,
			MEAS_CNT,
			MEAS_VALUE,
			MEAS_STS,
			MEAS_STF,
			MEAS_PDA,
			AUFNR,
			MEAS_MACH,
			MEAS_DES,
			OIL_CD,
			MEAS_IMGN,
			MEAS_FILE,
			MEAS_PATH,
			MEAS_USER,
			MEAS_IDATE,
			MEAS_SPT
			) VALUES (
			#MUSER2#,#MUSER3#,#MUSER4#,#MUSER5#,#MUSER1#,#CG_SEQ#,#POINT_SEQ#,#ITEM_SEQ#,#MEAS_DTIME#,#MEAS_CNT#,
			#MEAS_VALUE#,#MEAS_STS#,#MEAS_STF#,#MEAS_PDA#,#AUFNR#,#MEAS_MACH#,#MEAS_DES#,#OIL_CD#,#MEAS_IMGN#,#MEAS_FILE#,
			#MEAS_PATH#,#MEAS_USER#,#MEAS_IDATE#,
			#MEAS_SPT:CLOB#)
	
	</insert>
	
</sqlMap>

